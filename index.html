<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Power Theft Detection</title>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js" type="module"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f0f0f0; }
    #loginBox, #adminPage, #consumerPage { display: none; }
    table { margin: 20px auto; border-collapse: collapse; width: 80%; }
    th, td { padding: 10px; border: 1px solid #333; }
    .alert { animation: blink 1s infinite; background: red; color: white; padding: 10px; }
    @keyframes blink {
      0% { background: red; }
      50% { background: yellow; color:black; }
      100% { background: red; }
    }
  </style>
</head>
<body>
  <h1>⚡ Power Theft Monitoring System</h1>

  <!-- Login Box -->
  <div id="loginBox">
    <h2>Login</h2>
    <input type="text" id="userid" placeholder="User ID"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
  </div>

  <!-- Admin Page -->
  <div id="adminPage">
    <h2>Admin Dashboard</h2>
    <h3>Transformer Side (ESP32-1)</h3>
    <table>
      <tr><th>Voltage</th><td id="tVolt"></td></tr>
      <tr><th>Current</th><td id="tCurr"></td></tr>
      <tr><th>Power</th><td id="tPower"></td></tr>
      <tr><th>Energy</th><td id="tEnergy"></td></tr>
      <tr><th>Frequency</th><td id="tFreq"></td></tr>
      <tr><th>Power Factor</th><td id="tPF"></td></tr>
    </table>

    <h3>Consumer Side (ESP32-2)</h3>
    <table>
      <tr><th>Voltage</th><td id="cVolt"></td></tr>
      <tr><th>Current</th><td id="cCurr"></td></tr>
      <tr><th>Power</th><td id="cPower"></td></tr>
      <tr><th>Energy</th><td id="cEnergy"></td></tr>
      <tr><th>Frequency</th><td id="cFreq"></td></tr>
      <tr><th>Power Factor</th><td id="cPF"></td></tr>
    </table>

    <h3>Fault Log</h3>
    <div id="faultLog"></div>

    <h3>Power Graph</h3>
    <canvas id="powerChart" width="600" height="300"></canvas>

    <button onclick="logout()">Logout</button>
  </div>

  <!-- Consumer Page -->
  <div id="consumerPage">
    <h2>Consumer Dashboard</h2>
    <h3>Consumer Side (ESP32-2)</h3>
    <table>
      <tr><th>Voltage</th><td id="cVolt2"></td></tr>
      <tr><th>Current</th><td id="cCurr2"></td></tr>
      <tr><th>Power</th><td id="cPower2"></td></tr>
      <tr><th>Energy</th><td id="cEnergy2"></td></tr>
      <tr><th>Frequency</th><td id="cFreq2"></td></tr>
      <tr><th>Power Factor</th><td id="cPF2"></td></tr>
    </table>

    <h3>Fault Log</h3>
    <div id="faultLog2"></div>

    <button onclick="logout()">Logout</button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
    import { getDatabase, ref, onValue, push } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDieP1yWZCYfw22llojBCY_rBk0vRwEH7k",
      authDomain: "iot-based-power-theft.firebaseapp.com",
      databaseURL: "https://iot-based-power-theft-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "iot-based-power-theft",
      storageBucket: "iot-based-power-theft.appspot.com",
      messagingSenderId: "300681383944",
      appId: "1:300681383944:web:d9447408905b8afd6981bd"
    };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // Login System
    function login() {
      let id = document.getElementById("userid").value;
      let pass = document.getElementById("password").value;

      if(id==="admin123" && pass==="admin123"){
        document.getElementById("loginBox").style.display="none";
        document.getElementById("adminPage").style.display="block";
        startAdmin();
      }
      else if(id==="consumer123" && pass==="consumer123"){
        document.getElementById("loginBox").style.display="none";
        document.getElementById("consumerPage").style.display="block";
        startConsumer();
      } else {
        alert("Invalid Login!");
      }
    }
    window.login = login;

    function logout(){
      location.reload();
    }
    window.logout = logout;

    // Realtime Data
    let faultTimer = null;
    let faultActive = false;

    function startAdmin(){
      const tRef = ref(db, "ESP32_1");
      const cRef = ref(db, "ESP32_2");
      const faultRef = ref(db, "FaultLogs");

      let chartCtx = document.getElementById("powerChart").getContext("2d");
      let powerChart = new Chart(chartCtx, {
        type: "line",
        data: { labels: [], datasets: [
          { label: "Transformer Power", data: [], borderColor: "red", fill: false },
          { label: "Consumer Power", data: [], borderColor: "blue", fill: false }
        ]},
        options: { scales: { x: { title: { display: true, text: "Time" } }, y: { beginAtZero: true }}}
      });

      onValue(tRef, (snapshot)=>{
        let d = snapshot.val();
        if(!d) return;
        document.getElementById("tVolt").innerText = d.Voltage;
        document.getElementById("tCurr").innerText = d.Current;
        document.getElementById("tPower").innerText = d.Power;
        document.getElementById("tEnergy").innerText = d.Energy;
        document.getElementById("tFreq").innerText = d.Frequency;
        document.getElementById("tPF").innerText = d.PowerFactor;

        // Update chart
        let now = new Date().toLocaleTimeString();
        powerChart.data.labels.push(now);
        powerChart.data.datasets[0].data.push(d.Power);
        if(powerChart.data.labels.length>20){ // keep last 20 points
          powerChart.data.labels.shift();
          powerChart.data.datasets[0].data.shift();
          powerChart.data.datasets[1].data.shift();
        }
        powerChart.update();
      });

      onValue(cRef, (snapshot)=>{
        let d = snapshot.val();
        if(!d) return;
        document.getElementById("cVolt").innerText = d.Voltage;
        document.getElementById("cCurr").innerText = d.Current;
        document.getElementById("cPower").innerText = d.Power;
        document.getElementById("cEnergy").innerText = d.Energy;
        document.getElementById("cFreq").innerText = d.Frequency;
        document.getElementById("cPF").innerText = d.PowerFactor;

        // push consumer power to chart
        powerChart.data.datasets[1].data.push(d.Power);
        powerChart.update();

        checkFault();
      });

      function checkFault(){
        let tPower = parseFloat(document.getElementById("tPower").innerText||0);
        let cPower = parseFloat(document.getElementById("cPower").innerText||0);
        if(tPower - cPower > 30){
          if(!faultTimer){
            faultTimer = setTimeout(()=>{
              faultActive = true;
              document.body.classList.add("alert");
              let log = "⚠️ Power Theft Detected! Transformer: "+tPower+"W Consumer: "+cPower+"W at "+new Date().toLocaleTimeString();
              let logDiv = document.getElementById("faultLog");
              logDiv.innerHTML += "<p>"+log+"</p>";
              push(faultRef, {msg: log, time: Date.now()});
            }, 5000); // Only if continues for >5s
          }
        } else {
          clearTimeout(faultTimer);
          faultTimer = null;
          if(faultActive){
            document.body.classList.remove("alert");
            faultActive=false;
          }
        }
      }

      onValue(faultRef, (snapshot)=>{
        let logs = snapshot.val();
        if(!logs) return;
        let logDiv = document.getElementById("faultLog");
        logDiv.innerHTML="";
        Object.values(logs).forEach(l=>{
          logDiv.innerHTML+="<p>"+l.msg+"</p>";
        });
      });
    }

    function startConsumer(){
      const cRef = ref(db, "ESP32_2");
      const faultRef = ref(db, "FaultLogs");

      onValue(cRef, (snapshot)=>{
        let d = snapshot.val();
        if(!d) return;
        document.getElementById("cVolt2").innerText = d.Voltage;
        document.getElementById("cCurr2").innerText = d.Current;
        document.getElementById("cPower2").innerText = d.Power;
        document.getElementById("cEnergy2").innerText = d.Energy;
        document.getElementById("cFreq2").innerText = d.Frequency;
        document.getElementById("cPF2").innerText = d.PowerFactor;
      });

      onValue(faultRef, (snapshot)=>{
        let logs = snapshot.val();
        if(!logs) return;
        let logDiv = document.getElementById("faultLog2");
        logDiv.innerHTML="";
        Object.values(logs).forEach(l=>{
          logDiv.innerHTML+="<p>"+l.msg+"</p>";
        });
      });
    }

    // Show login first
    document.getElementById("loginBox").style.display="block";
  </script>
</body>
</html>
