<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Power Monitoring System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .dashboard-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            transition: transform 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
        }
        .alert-theft {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.9);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            font-size: 2rem;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { background-color: rgba(255, 0, 0, 0.9); }
            50% { background-color: rgba(200, 0, 0, 0.9); }
            100% { background-color: rgba(255, 0, 0, 0.9); }
        }
        .reading-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }
        .unit {
            font-size: 0.9rem;
            color: #7f8c8d;
        }
        .bill-table {
            font-size: 0.9rem;
        }
        .nav-tabs .nav-link.active {
            font-weight: bold;
            border-bottom: 3px solid #0d6efd;
        }
        .theft-log {
            max-height: 300px;
            overflow-y: auto;
        }
        .consumer-bg {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        .admin-bg {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
        }
        .data-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="container-fluid">
        <div class="row justify-content-center">
            <div class="col-md-4">
                <div class="login-container text-center">
                    <h2 class="mb-4"><i class="fas fa-bolt text-warning"></i> Power Monitoring System</h2>
                    <div class="mb-4">
                        <img src="https://cdn-icons-png.flaticon.com/512/3627/3627088.png" alt="Energy Icon" width="100">
                    </div>
                    <div class="mb-3">
                        <input type="text" id="username" class="form-control" placeholder="User ID">
                    </div>
                    <div class="mb-3">
                        <input type="password" id="password" class="form-control" placeholder="Password">
                    </div>
                    <button id="login-btn" class="btn btn-primary w-100">Login</button>
                    <div class="mt-3">
                        <p class="text-muted">Demo Accounts:<br>
                            Consumer: house111 / house111<br>
                            Admin: admin111 / admin111
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consumer Dashboard -->
    <div id="consumer-dashboard" class="container-fluid d-none consumer-bg">
        <div class="dashboard-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-home text-primary"></i> Consumer Dashboard - House111</h2>
                <button id="consumer-logout" class="btn btn-outline-secondary">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">Current Power Readings</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="text-muted">Voltage</div>
                                    <div class="reading-value"><span id="consumer-voltage">0.00</span> <span class="unit">V</span></div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted">Current</div>
                                    <div class="reading-value"><span id="consumer-current">0.00</span> <span class="unit">A</span></div>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="text-muted">Power</div>
                                    <div class="reading-value"><span id="consumer-power">0.00</span> <span class="unit">W</span></div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted">Energy</div>
                                    <div class="reading-value"><span id="consumer-energy">0.00</span> <span class="unit">kWh</span></div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-muted">Frequency</div>
                                    <div class="reading-value"><span id="consumer-frequency">0.00</span> <span class="unit">Hz</span></div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted">Power Factor</div>
                                    <div class="reading-value"><span id="consumer-pf">0.00</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">Bill Information</h5>
                        </div>
                        <div class="card-body text-center">
                            <button id="calculate-bill" class="btn btn-warning mb-3">
                                <i class="fas fa-file-invoice-dollar"></i> Calculate Bill
                            </button>
                            <div id="bill-details" class="d-none">
                                <h5>Last Two Months Consumption</h5>
                                <table class="table bill-table">
                                    <thead>
                                        <tr>
                                            <th>Month</th>
                                            <th>Energy (kWh)</th>
                                            <th>Amount (₹)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>Previous Month</td>
                                            <td id="prev-month-energy">0</td>
                                            <td id="prev-month-amount">0.00</td>
                                        </tr>
                                        <tr>
                                            <td>Current Month</td>
                                            <td id="current-month-energy">0</td>
                                            <td id="current-month-amount">0.00</td>
                                        </tr>
                                    </tbody>
                                </table>
                                <div class="alert alert-info">
                                    <small>Tariff: 0-200 units ₹4.95/unit, 401-500 units ₹11.05/unit</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Historical Data</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12">
                            <div id="historical-data" class="text-center">
                                <p class="text-muted">Historical data will be displayed here as it accumulates</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="admin-dashboard" class="container-fluid d-none admin-bg">
        <div class="dashboard-container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-user-cog text-danger"></i> Admin Dashboard</h2>
                <button id="admin-logout" class="btn btn-outline-secondary">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>

            <ul class="nav nav-tabs mb-4" id="adminTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="monitoring-tab" data-bs-toggle="tab" data-bs-target="#monitoring" type="button" role="tab">Power Monitoring</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="theft-log-tab" data-bs-toggle="tab" data-bs-target="#theft-log" type="button" role="tab">Theft Log</button>
                </li>
            </ul>

            <div class="tab-content" id="adminTabContent">
                <div class="tab-pane fade show active" id="monitoring" role="tabpanel">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Distribution Transformer (Board 1)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="text-muted">Voltage</div>
                                            <div class="reading-value"><span id="transformer-voltage">0.00</span> <span class="unit">V</span></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted">Current</div>
                                            <div class="reading-value"><span id="transformer-current">0.00</span> <span class="unit">A</span></div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="text-muted">Power</div>
                                            <div class="reading-value"><span id="transformer-power">0.00</span> <span class="unit">W</span></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted">Energy</div>
                                            <div class="reading-value"><span id="transformer-energy">0.00</span> <span class="unit">kWh</span></div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="text-muted">Frequency</div>
                                            <div class="reading-value"><span id="transformer-frequency">0.00</span> <span class="unit">Hz</span></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted">Power Factor</div>
                                            <div class="reading-value"><span id="transformer-pf">0.00</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">House111 (Board 2)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="text-muted">Voltage</div>
                                            <div class="reading-value"><span id="admin-voltage">0.00</span> <span class="unit">V</span></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted">Current</div>
                                            <div class="reading-value"><span id="admin-current">0.00</span> <span class="unit">A</span></div>
                                        </div>
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="text-muted">Power</div>
                                            <div class="reading-value"><span id="admin-power">0.00</span> <span class="unit">W</span></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted">Energy</div>
                                            <div class="reading-value"><span id="admin-energy">0.00</span> <span class="unit">kWh</span></div>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="text-muted">Frequency</div>
                                            <div class="reading-value"><span id="admin-frequency">0.00</span> <span class="unit">Hz</span></div>
                                        </div>
                                        <div class="col-6">
                                            <div class="text-muted">Power Factor</div>
                                            <div class="reading-value"><span id="admin-pf">0.00</span></div>
                                        </div>
                                    </div>
                                    <div class="alert alert-warning mt-3">
                                        <div class="text-muted">Power Difference</div>
                                        <div class="reading-value"><span id="power-difference">0.00</span> <span class="unit">W</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade" id="theft-log" role="tabpanel">
                    <div class="card">
                        <div class="card-header bg-danger text-white">
                            <h5 class="mb-0">Power Theft Incidents</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive theft-log">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Date & Time</th>
                                            <th>Transformer Power</th>
                                            <th>Consumer Power</th>
                                            <th>Difference</th>
                                        </tr>
                                    </thead>
                                    <tbody id="theft-log-body">
                                        <!-- Theft incidents will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Theft Alert -->
    <div id="theft-alert" class="alert-theft d-none">
        <div class="text-center">
            <h1><i class="fas fa-exclamation-triangle"></i> POWER THEFT DETECTED!</h1>
            <h3>Difference: <span id="alert-difference">0</span> W</h3>
            <p>Please investigate immediately</p>
            <button id="dismiss-alert" class="btn btn-light mt-3">Dismiss Alert</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDieP1yWZCYfw22llojBCY_rBk0vRwEH7k",
            authDomain: "iot-based-power-theft.firebaseapp.com",
            databaseURL: "https://iot-based-power-theft-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "iot-based-power-theft",
            storageBucket: "iot-based-power-theft.firebasestorage.app",
            messagingSenderId: "300681383944",
            appId: "1:300681383944:web:d9447408905b8afd6981bd"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const loginPage = document.getElementById('login-page');
        const consumerDashboard = document.getElementById('consumer-dashboard');
        const adminDashboard = document.getElementById('admin-dashboard');
        const theftAlert = document.getElementById('theft-alert');
        
        // Login functionality
        document.getElementById('login-btn').addEventListener('click', function() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            if (username === 'house111' && password === 'house111') {
                loginPage.classList.add('d-none');
                consumerDashboard.classList.remove('d-none');
                startConsumerDataFetch();
            } else if (username === 'admin111' && password === 'admin111') {
                loginPage.classList.add('d-none');
                adminDashboard.classList.remove('d-none');
                startAdminDataFetch();
            } else {
                alert('Invalid credentials. Please try again.');
            }
        });

        // Logout functionality
        document.getElementById('consumer-logout').addEventListener('click', function() {
            consumerDashboard.classList.add('d-none');
            loginPage.classList.remove('d-none');
        });

        document.getElementById('admin-logout').addEventListener('click', function() {
            adminDashboard.classList.add('d-none');
            loginPage.classList.remove('d-none');
        });

        // Dismiss theft alert
        document.getElementById('dismiss-alert').addEventListener('click', function() {
            theftAlert.classList.add('d-none');
        });

        // Bill calculation
        document.getElementById('calculate-bill').addEventListener('click', function() {
            calculateBill();
            document.getElementById('bill-details').classList.remove('d-none');
        });

        // Function to calculate bill based on energy consumption
        function calculateBill() {
            // Get current energy value
            const energyElement = document.getElementById('consumer-energy');
            const energy = parseFloat(energyElement.textContent) || 0;
            
            // Calculate bill based on tariff
            let amount = 0;
            if (energy <= 200) {
                amount = energy * 4.95;
            } else if (energy > 200 && energy <= 400) {
                amount = (200 * 4.95) + ((energy - 200) * 8.00);
            } else if (energy > 400 && energy <= 500) {
                amount = (200 * 4.95) + (200 * 8.00) + ((energy - 400) * 11.05);
            } else {
                amount = (200 * 4.95) + (200 * 8.00) + (100 * 11.05) + ((energy - 500) * 12.50);
            }
            
            // Set values for display
            document.getElementById('current-month-energy').textContent = energy.toFixed(2);
            document.getElementById('current-month-amount').textContent = amount.toFixed(2);
            
            // For demonstration, set previous month as 10% less
            const prevEnergy = energy * 0.9;
            let prevAmount = 0;
            if (prevEnergy <= 200) {
                prevAmount = prevEnergy * 4.95;
            } else if (prevEnergy > 200 && prevEnergy <= 400) {
                prevAmount = (200 * 4.95) + ((prevEnergy - 200) * 8.00);
            } else if (prevEnergy > 400 && prevEnergy <= 500) {
                prevAmount = (200 * 4.95) + (200 * 8.00) + ((prevEnergy - 400) * 11.05);
            } else {
                prevAmount = (200 * 4.95) + (200 * 8.00) + (100 * 11.05) + ((prevEnergy - 500) * 12.50);
            }
            
            document.getElementById('prev-month-energy').textContent = prevEnergy.toFixed(2);
            document.getElementById('prev-month-amount').textContent = prevAmount.toFixed(2);
        }

        // Consumer data fetch from Firebase
        function startConsumerDataFetch() {
            const consumerRef = database.ref('sensor_data/board2');
            
            consumerRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('consumer-voltage').textContent = data.voltage.toFixed(2);
                    document.getElementById('consumer-current').textContent = data.current.toFixed(3);
                    document.getElementById('consumer-power').textContent = data.power.toFixed(1);
                    document.getElementById('consumer-energy').textContent = data.energy.toFixed(3);
                    document.getElementById('consumer-frequency').textContent = data.frequency.toFixed(1);
                    document.getElementById('consumer-pf').textContent = data.pf.toFixed(2);
                    
                    // Update historical data display
                    updateHistoricalData('consumer', data);
                }
            });
        }

        // Admin data fetch from Firebase
        function startAdminDataFetch() {
            const transformerRef = database.ref('sensor_data/board1');
            const consumerRef = database.ref('sensor_data/board2');
            
            transformerRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('transformer-voltage').textContent = data.voltage.toFixed(2);
                    document.getElementById('transformer-current').textContent = data.current.toFixed(3);
                    document.getElementById('transformer-power').textContent = data.power.toFixed(1);
                    document.getElementById('transformer-energy').textContent = data.energy.toFixed(3);
                    document.getElementById('transformer-frequency').textContent = data.frequency.toFixed(1);
                    document.getElementById('transformer-pf').textContent = data.pf.toFixed(2);
                    
                    // Check for power theft
                    checkPowerTheft();
                }
            });
            
            consumerRef.on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    document.getElementById('admin-voltage').textContent = data.voltage.toFixed(2);
                    document.getElementById('admin-current').textContent = data.current.toFixed(3);
                    document.getElementById('admin-power').textContent = data.power.toFixed(1);
                    document.getElementById('admin-energy').textContent = data.energy.toFixed(3);
                    document.getElementById('admin-frequency').textContent = data.frequency.toFixed(1);
                    document.getElementById('admin-pf').textContent = data.pf.toFixed(2);
                    
                    // Check for power theft
                    checkPowerTheft();
                }
            });
        }

        // Check for power theft
        function checkPowerTheft() {
            const transformerPower = parseFloat(document.getElementById('transformer-power').textContent) || 0;
            const consumerPower = parseFloat(document.getElementById('admin-power').textContent) || 0;
            
            const powerDiff = Math.abs(transformerPower - consumerPower);
            document.getElementById('power-difference').textContent = powerDiff.toFixed(1);
            
            // Check if difference exceeds threshold (20W)
            if (powerDiff > 20) {
                document.getElementById('alert-difference').textContent = powerDiff.toFixed(1);
                theftAlert.classList.remove('d-none');
                
                // Play alert sound
                const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-alarm-digital-clock-beep-989.mp3');
                audio.play();
                
                // Log theft incident
                logTheftIncident(transformerPower, consumerPower, powerDiff);
            }
        }

        // Log theft incident
        function logTheftIncident(transformerPower, consumerPower, difference) {
            const now = new Date();
            const dateTime = now.toLocaleString();
            
            const logEntry = `
                <tr>
                    <td>${dateTime}</td>
                    <td>${transformerPower.toFixed(1)} W</td>
                    <td>${consumerPower.toFixed(1)} W</td>
                    <td>${difference.toFixed(1)} W</td>
                </tr>
            `;
            
            // Prepend new log entry
            document.getElementById('theft-log-body').innerHTML = logEntry + document.getElementById('theft-log-body').innerHTML;
        }

        // Update historical data display
        function updateHistoricalData(type, data) {
            const historicalDiv = document.getElementById('historical-data');
            
            // Create a simple display of recent readings
            const readingTime = new Date().toLocaleTimeString();
            const readingHtml = `
                <div class="data-card">
                    <div class="row">
                        <div class="col-3"><strong>Time:</strong> ${readingTime}</div>
                        <div class="col-2"><strong>V:</strong> ${data.voltage.toFixed(2)} V</div>
                        <div class="col-2"><strong>A:</strong> ${data.current.toFixed(3)} A</div>
                        <div class="col-2"><strong>W:</strong> ${data.power.toFixed(1)} W</div>
                        <div class="col-3"><strong>Energy:</strong> ${data.energy.toFixed(3)} kWh</div>
                    </div>
                </div>
            `;
            
            // Prepend new reading
            historicalDiv.innerHTML = readingHtml + historicalDiv.innerHTML;
            
            // Limit to 10 most recent readings
            const readings = historicalDiv.querySelectorAll('.data-card');
            if (readings.length > 10) {
                readings[readings.length - 1].remove();
            }
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Check if user was previously logged in
            const savedUser = localStorage.getItem('powerUser');
            if (savedUser) {
                const userData = JSON.parse(savedUser);
                document.getElementById('username').value = userData.username;
                document.getElementById('password').value = userData.password;
            }
            
            // Add enter key login functionality
            document.getElementById('password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('login-btn').click();
                }
            });
        });
    </script>
</body>
</html>
