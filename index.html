<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Power Theft Monitoring</title>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js" type="module"></script>
  <script src="https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js" type="module"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; background: #f5f5f5; }
    .hidden { display: none; }
    .blink { animation: blink 1s infinite; }
    @keyframes blink { 50% { background-color: red; color:white; } }
    .container { margin: 20px auto; padding: 20px; width: 90%; background: white; border-radius: 10px; }
    table { margin: 10px auto; border-collapse: collapse; width: 80%; }
    table, th, td { border: 1px solid black; padding: 6px; text-align: center; }
    button { margin: 10px; padding: 8px 15px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>🔌 Power Theft Monitoring System</h1>

  <!-- Login -->
  <div id="loginDiv" class="container">
    <h2>Login</h2>
    <input type="text" id="userid" placeholder="User ID"><br><br>
    <input type="password" id="password" placeholder="Password"><br><br>
    <button onclick="login()">Login</button>
  </div>

  <!-- Admin Page -->
  <div id="adminPage" class="container hidden">
    <h2>Admin Dashboard (Transformer + Consumer)</h2>
    <div id="alertBox"></div>

    <h3>Transformer (ESP32-1)</h3>
    <div id="transformerData"></div>
    <canvas id="transformerChart"></canvas>

    <h3>Consumer (ESP32-2)</h3>
    <div id="consumerData"></div>
    <canvas id="consumerChart"></canvas>

    <h3>Fault Log</h3>
    <table id="faultTable">
      <tr><th>Timestamp</th><th>Transformer Power (W)</th><th>Consumer Power (W)</th><th>Difference (W)</th></tr>
    </table>
    <button onclick="downloadLog()">Download Log (CSV)</button>
    <button onclick="logout()">Logout</button>
  </div>

  <!-- Consumer Page -->
  <div id="consumerPage" class="container hidden">
    <h2>Consumer Dashboard</h2>
    <div id="consumerDataOnly"></div>
    <canvas id="consumerOnlyChart"></canvas>

    <h3>Fault Log</h3>
    <table id="consumerFaultTable">
      <tr><th>Timestamp</th><th>Transformer Power (W)</th><th>Consumer Power (W)</th><th>Difference (W)</th></tr>
    </table>
    <button onclick="downloadLog()">Download Log (CSV)</button>
    <button onclick="logout()">Logout</button>
  </div>

<script type="module">
  // ---------------- Firebase Setup ----------------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDieP1yWZCYfw22llojBCY_rBk0vRwEH7k",
    authDomain: "iot-based-power-theft.firebaseapp.com",
    databaseURL: "https://iot-based-power-theft-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "iot-based-power-theft",
    storageBucket: "iot-based-power-theft.appspot.com",
    messagingSenderId: "300681383944",
    appId: "1:300681383944:web:d9447408905b8afd6981bd"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------------- Variables ----------------
  let userType = "";  
  let faultLog = [];
  let faultTimer = null;
  let faultActive = false;

  // Chart.js setup
  const transformerChart = new Chart(document.getElementById("transformerChart"), {
    type: 'line',
    data: { labels: [], datasets: [{ label: "Transformer Power (W)", data: [], borderColor: "blue" }] }
  });
  const consumerChart = new Chart(document.getElementById("consumerChart"), {
    type: 'line',
    data: { labels: [], datasets: [{ label: "Consumer Power (W)", data: [], borderColor: "green" }] }
  });
  const consumerOnlyChart = new Chart(document.getElementById("consumerOnlyChart"), {
    type: 'line',
    data: { labels: [], datasets: [{ label: "Consumer Power (W)", data: [], borderColor: "green" }] }
  });

  // ---------------- Login ----------------
  window.login = function() {
    const id = document.getElementById("userid").value;
    const pass = document.getElementById("password").value;

    if (id==="admin123" && pass==="admin123") {
      userType="admin";
      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("adminPage").classList.remove("hidden");
      loadData();
    }
    else if (id==="consumer123" && pass==="consumer123") {
      userType="consumer";
      document.getElementById("loginDiv").classList.add("hidden");
      document.getElementById("consumerPage").classList.remove("hidden");
      loadData();
    }
    else {
      alert("❌ Invalid credentials!");
    }
  }

  window.logout = function() {
    location.reload();
  }

  // ---------------- Data Load ----------------
  function loadData(){
    const tRef = ref(db, "ESP32_1");
    const cRef = ref(db, "ESP32_2");

    onValue(tRef, snap => {
      if(!snap.exists()) return;
      const data = snap.val();
      updateTransformer(data);
    });
    onValue(cRef, snap => {
      if(!snap.exists()) return;
      const data = snap.val();
      updateConsumer(data);
    });
  }

  // ---------------- Update UI ----------------
  function updateTransformer(data){
    if(userType==="admin"){
      document.getElementById("transformerData").innerHTML = `
        Voltage: ${data.Voltage} V<br>
        Current: ${data.Current} A<br>
        Power: ${data.Power} W<br>
        Energy: ${data.Energy} kWh<br>
        PF: ${data.PF}<br>
        Freq: ${data.Freq} Hz
      `;
      addData(transformerChart, data.Power);
    }
    checkFault();
  }

  function updateConsumer(data){
    if(userType==="admin"){
      document.getElementById("consumerData").innerHTML = `
        Voltage: ${data.Voltage} V<br>
        Current: ${data.Current} A<br>
        Power: ${data.Power} W<br>
        Energy: ${data.Energy} kWh<br>
        PF: ${data.PF}<br>
        Freq: ${data.Freq} Hz
      `;
      addData(consumerChart, data.Power);
    }
    if(userType==="consumer"){
      document.getElementById("consumerDataOnly").innerHTML = `
        Voltage: ${data.Voltage} V<br>
        Current: ${data.Current} A<br>
        Power: ${data.Power} W<br>
        Energy: ${data.Energy} kWh<br>
        PF: ${data.PF}<br>
        Freq: ${data.Freq} Hz
      `;
      addData(consumerOnlyChart, data.Power);
    }
    checkFault();
  }

  function addData(chart, value){
    const now = new Date().toLocaleTimeString();
    chart.data.labels.push(now);
    chart.data.datasets[0].data.push(value);
    if(chart.data.labels.length > 20){
      chart.data.labels.shift();
      chart.data.datasets[0].data.shift();
    }
    chart.update();
  }

  // ---------------- Fault Detection ----------------
  function checkFault(){
    const tPower = transformerChart.data.datasets[0].data.slice(-1)[0];
    const cPower = (userType==="admin" ? consumerChart.data.datasets[0].data.slice(-1)[0] : consumerOnlyChart.data.datasets[0].data.slice(-1)[0]);

    if(!tPower || !cPower) return;

    const diff = tPower - cPower;
    if(diff > 30){
      if(!faultTimer){
        faultTimer = setTimeout(() => {
          logFault(tPower, cPower, diff);
          document.body.classList.add("blink");
          faultActive = true;
        }, 5000); // only if persists for 5s
      }
    } else {
      clearTimeout(faultTimer);
      faultTimer=null;
      if(faultActive){
        document.body.classList.remove("blink");
        faultActive=false;
      }
    }
  }

  function logFault(tp, cp, diff){
    const ts = new Date().toLocaleString();
    const row = `<tr><td>${ts}</td><td>${tp}</td><td>${cp}</td><td>${diff}</td></tr>`;
    faultLog.push({Timestamp: ts, Transformer: tp, Consumer: cp, Difference: diff});

    if(userType==="admin")
      document.getElementById("faultTable").innerHTML += row;
    if(userType==="consumer")
      document.getElementById("consumerFaultTable").innerHTML += row;
  }

  // ---------------- Download Log ----------------
  window.downloadLog = function(){
    if(faultLog.length===0){ alert("No faults logged!"); return; }
    let csv = "Timestamp,Transformer Power,Consumer Power,Difference\n";
    faultLog.forEach(r=>{
      csv += `${r.Timestamp},${r.Transformer},${r.Consumer},${r.Difference}\n`;
    });
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href=url;
    a.download="fault_log.csv";
    a.click();
  }
</script>
</body>
</html>
